<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>设计自己的Trait编辑器 &mdash; 用Python做科学计算</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link type="text/css" href="_static/jquery-ui-1.7.2.custom.css" rel="stylesheet" />	
    <link type="text/css" href="_static/comments.css" rel="stylesheet" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '#',
        VERSION:     '1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/jquery-ui-1.7.2.custom.min.js"></script>
    <script type="text/javascript" src="_static/pydoc.js"></script>
    <link rel="top" title="用Python做科学计算" href="index.html" />
    <link rel="up" title="Traits使用手册" href="traits_manual_index.html" />
    <link rel="下一篇" title="Visual使用手册" href="visual_manual_index.html" />
    <link rel="上一篇" title="Trait事件处理" href="traits_manual_notification.html" /> 

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-10837468-1");
pageTracker._trackPageview();
} catch(err) {}</script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="visual_manual_index.html" title="Visual使用手册"
             accesskey="N">下一篇</a></li>
        <li class="right" >
          <a href="traits_manual_notification.html" title="Trait事件处理"
             accesskey="P">上一篇</a> |</li>
        <li class="right" style="margin-right:10px">
        <a href="#" id="toggle_sidebar">←切换侧栏(Alt+X)</a> |
        </li>
        <li><a href="index.html">用Python做科学计算</a> &raquo;</li>
          <li><a href="traits_manual_index.html" accesskey="U">Traits使用手册</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="trait">
<h1>设计自己的Trait编辑器<a class="headerlink" href="#trait" title="Permalink to this headline">¶</a></h1>
<p>在前面的章节中我们知道，每种trait属性都对应有缺省的trait编辑器，如果在View中不指定编辑器的话，将使用缺省的编辑器构成界面。每个编辑器都可以对应有多个后台，目前支持的后台界面库有pyQt和wxPython。每种编辑器都可以有四种样式：simple, custom, text, readonly。</p>
<p>traitsUI为我们提供了很丰富的编辑器库，以至于我们很少有自己设计编辑器的需求，然而如果我们能方便地设计自己的编辑器，将能制作出更加专业的程序界面。</p>
<p>本章节将简要介绍trait编辑器的工作原理；并且制作一个新的trait编辑器，用以显示matplotlib提供的绘图控件；然后以此控件制作一个通用的绘制CSV文件数据图像的小工具。</p>
<div class="section" id="id1">
<h2>Trait编辑器的工作原理<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>我们先来看下面这个小程序，它定义了一个TestStrEditor类，其中有一个名为test的trait属性，其类型为Str，在view中用Item定义要在界面中显示test属性，但是没有指定它所使用的编辑器(通过editor参数)。当执行t.configure_traits()时，traits库将自动为我们挑选文本编辑框控件作为test属性的编辑器：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">enthought.traits.api</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">enthought.traits.ui.api</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">TestStrEditor</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">Str</span>
    <span class="n">view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">))</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">TestStrEditor</span><span class="p">()</span>
<span class="n">t</span><span class="o">.</span><span class="n">configure_traits</span><span class="p">()</span>
</pre></div>
</div>
<div class="figure" id="fig-traitsuimanual01">
<img alt="_images/traitsui_manual_01.png" src="_images/traitsui_manual_01.png" />
<p class="caption">使用文本编辑框控件编辑test属性</p>
</div>
<div class="topic">
<p class="topic-title first">Traits库的路径</p>
<p>下面的介绍需要查看traits库的源程序，因此首先你需要知道它们在哪里：</p>
<p><strong>traits</strong>: site-packages\Traits-3.2.0-py2.6-win32.egg\enthought\traits, 以下简称 %traits%</p>
<p><strong>traitsUI</strong>: site-packages\Traits-3.2.0-py2.6-win32.egg\enthought\traits\UI, 以下简称 %ui%</p>
<p><strong>wx后台界面库</strong>: site-packages\TraitsBackendWX-3.2.0-py2.6.egg\enthought\traitsui\wx, 以下简称 %wx%</p>
</div>
<p>Str对象的缺省编辑器通过其create_editor方法获得：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">enthought.traits.api</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">Str</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ed</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">create_editor</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">ed</span><span class="p">)</span>
<span class="go">&lt;class &#39;enthought.traits.ui.editors.text_editor.ToolkitEditorFactory&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ed</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">{&#39;auto_set&#39;: True,</span>
<span class="go"> &#39;custom_editor_class&#39;: &lt;class &#39;enthought.traits.ui.wx.text_editor.CustomEditor&#39;&gt;,</span>
<span class="go"> &#39;enabled&#39;: True,</span>
<span class="go"> &#39;enter_set&#39;: False,</span>
<span class="go"> &#39;evaluate&#39;: &lt;enthought.traits.ui.editors.text_editor._Identity object at 0x0427F1B0&gt;,</span>
<span class="go"> &#39;evaluate_name&#39;: &#39;&#39;,</span>
<span class="go"> &#39;format_func&#39;: None,</span>
<span class="go"> &#39;format_str&#39;: &#39;&#39;,</span>
<span class="go"> &#39;invalid&#39;: &#39;&#39;,</span>
<span class="go"> &#39;is_grid_cell&#39;: False,</span>
<span class="go"> &#39;mapping&#39;: {},</span>
<span class="go"> &#39;multi_line&#39;: True,</span>
<span class="go"> &#39;password&#39;: False,</span>
<span class="go"> &#39;readonly_editor_class&#39;: &lt;class &#39;enthought.traits.ui.wx.text_editor.ReadonlyEditor&#39;&gt;,</span>
<span class="go"> &#39;simple_editor_class&#39;: &lt;class &#39;enthought.traits.ui.wx.text_editor.SimpleEditor&#39;&gt;,</span>
<span class="go"> &#39;text_editor_class&#39;: &lt;class &#39;enthought.traits.ui.wx.text_editor.SimpleEditor&#39;&gt;,</span>
<span class="go"> &#39;view&#39;: None}</span>
</pre></div>
</div>
<p>create_editor方法的源代码可以在%traits%trait_types.py中的BaseStr类的定义中找到。create_editor方法得到的是一个text_editor.ToolkitEditorFactory类：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">enthought</span><span class="o">.</span><span class="n">traits</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">editors</span><span class="o">.</span><span class="n">text_editor</span><span class="o">.</span><span class="n">ToolkitEditorFactory</span>
</pre></div>
</div>
<p>在%ui%editorstext_editor.py中你可以找到它的定义，它继承于EditorFactory类。EditorFactory类的代码在%ui%editor_factory.py中。EditorFactory类是Traits编辑器的核心，通过它和后台界面库联系起来。让我们来详细看看EditorFactory类中关于控件生成方面的代码：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">EditorFactory</span> <span class="p">(</span> <span class="n">HasPrivateTraits</span> <span class="p">):</span>
    <span class="c"># 下面四个属性描述四个类型的编辑器的类</span>
    <span class="n">simple_editor_class</span> <span class="o">=</span> <span class="n">Property</span>
    <span class="n">custom_editor_class</span> <span class="o">=</span> <span class="n">Property</span>
    <span class="n">text_editor_class</span>   <span class="o">=</span> <span class="n">Property</span>
    <span class="n">readonly_editor_class</span> <span class="o">=</span> <span class="n">Property</span>

    <span class="c"># 用simple_editor_class创建实际的控件</span>
    <span class="k">def</span> <span class="nf">simple_editor</span> <span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ui</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">parent</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_editor_class</span><span class="p">(</span> <span class="n">parent</span><span class="p">,</span>
                                         <span class="n">factory</span>     <span class="o">=</span> <span class="bp">self</span><span class="p">,</span>
                                         <span class="n">ui</span>          <span class="o">=</span> <span class="n">ui</span><span class="p">,</span>
                                         <span class="nb">object</span>      <span class="o">=</span> <span class="nb">object</span><span class="p">,</span>
                                         <span class="n">name</span>        <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
                                         <span class="n">description</span> <span class="o">=</span> <span class="n">description</span> <span class="p">)</span>


    <span class="c"># 这是类的方法，它通过类的以及父类自动找到与其匹配的后台界面库中的控件类</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_toolkit_editor</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">class_name</span><span class="p">):</span>
        <span class="n">editor_factory_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">factory_class</span> <span class="k">for</span> <span class="n">factory_class</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">mro</span><span class="p">()</span>
                                  <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">factory_class</span><span class="p">,</span> <span class="n">EditorFactory</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span> <span class="n">editor_factory_classes</span> <span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">factory_class</span> <span class="o">=</span> <span class="n">editor_factory_classes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">editor_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">factory_class</span><span class="o">.</span><span class="n">__module__</span><span class="p">]</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">toolkit_object</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">editor_file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                             <span class="n">class_name</span><span class="p">]),</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">editor_factory_classes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="c"># simple_editor_class属性的get方法，获取属性值</span>
    <span class="k">def</span> <span class="nf">_get_simple_editor_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">SimpleEditor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_toolkit_editor</span><span class="p">(</span><span class="s">&#39;SimpleEditor&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">SimpleEditor</span> <span class="o">=</span> <span class="n">toolkit_object</span><span class="p">(</span><span class="s">&#39;editor_factory:SimpleEditor&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SimpleEditor</span>
</pre></div>
</div>
<p>EditorFactory的对象有四个属性保存后台编辑器控件的类：simple_editor_class, custom_editor_class, text_editor_class, readonly_editor_class。例如前面例子中的ed对象的simple_editor_class为&lt;class 'enthought.traits.ui.wx.text_editor.SimpleEditor'&gt;，我们看到它用的是wx后台界面库中的text_editor中的SimpleEditor类，稍后我们将看看其内容。</p>
<p>EditorFactory是通过其类方法_get_toolkit_editor计算出所要用后台界面库中的类的。由于_get_toolkit_editor是类方法，它的第一个参数cls就是类本身。当调用text_editor.ToolkitEditorFactory._get_toolkit_editor()时，cls就是text_editor.ToolkitEditorFactory类。通过调用cls.mro获得cls以及其所有父类，然后一个一个地查找，从后台界面库中找到与之匹配的类，这个工作由toolkit_object函数完成。其源代码可以在%ui%toolkit.py中找到。</p>
<p>因为后台界面库中的类的组织结构和traits.ui是一样的，因此不需要额外的配置文件，只需要几个字符串替代操作就可以将traits.ui中的EditorFactory类和后台界面库中的实际的编辑器类联系起来。下图显示了traits.ui中的EditorFactory和后台界面库的关系。</p>
<div class="figure" id="fig-traitsuieditorfactory">
<img alt="_images/traitsui_editor_factory.png" src="_images/traitsui_editor_factory.png" />
<p class="caption">traits.ui中的EditorFactory和后台界面库的关系</p>
</div>
<p>wx后台界面库中定义了所有编辑器控件，在 %wx%text_editor.py 中你可以找到产生文本框控件的类 text_editor.SimpleEditor。类名表示了控件的样式：simple, custom, text, readonly，而其文件名(模块名)则表示了控件的类型。下面是 text_editor.SimpleEditor的部分代码：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SimpleEditor</span> <span class="p">(</span> <span class="n">Editor</span> <span class="p">):</span>

    <span class="c"># Flag for window styles:</span>
    <span class="n">base_style</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># Background color when input is OK:</span>
    <span class="n">ok_color</span> <span class="o">=</span> <span class="n">OKColor</span>

    <span class="c"># Function used to evaluate textual user input:</span>
    <span class="n">evaluate</span> <span class="o">=</span> <span class="n">evaluate_trait</span>

    <span class="k">def</span> <span class="nf">init</span> <span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">parent</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Finishes initializing the editor by creating the underlying toolkit</span>
<span class="sd">            widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">factory</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span>
        <span class="n">style</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">evaluate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_value</span><span class="p">(</span> <span class="n">factory</span><span class="o">.</span><span class="n">evaluate_name</span><span class="p">,</span> <span class="s">&#39;evaluate&#39;</span><span class="p">,</span> <span class="s">&#39;from&#39;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">factory</span><span class="o">.</span><span class="n">multi_line</span><span class="p">)</span> <span class="ow">or</span> <span class="n">factory</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_MULTILINE</span>

        <span class="k">if</span> <span class="n">factory</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">|=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TE_PASSWORD</span>

        <span class="n">multi_line</span> <span class="o">=</span> <span class="p">((</span><span class="n">style</span> <span class="o">&amp;</span> <span class="n">wx</span><span class="o">.</span><span class="n">TE_MULTILINE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">multi_line</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrollable</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">factory</span><span class="o">.</span><span class="n">enter_set</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">multi_line</span><span class="p">):</span>
            <span class="n">control</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span> <span class="n">parent</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_value</span><span class="p">,</span>
                                   <span class="n">style</span> <span class="o">=</span> <span class="n">style</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span> <span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">(</span> <span class="n">parent</span><span class="p">,</span> <span class="n">control</span><span class="o">.</span><span class="n">GetId</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_object</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">control</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span> <span class="n">parent</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_value</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="n">style</span> <span class="p">)</span>

        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">(</span> <span class="n">control</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_object</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">factory</span><span class="o">.</span><span class="n">auto_set</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">(</span> <span class="n">parent</span><span class="p">,</span> <span class="n">control</span><span class="o">.</span><span class="n">GetId</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_object</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_tooltip</span><span class="p">()</span>
</pre></div>
</div>
<p>真正产生控件的程序是在init方法中，此方法在产生界面时自动被调用，注意方法名是init，不要和对象初始化方法__init__搞混淆了。</p>
</div>
<div class="section" id="matplotlib">
<h2>制作matplotlib的编辑器<a class="headerlink" href="#matplotlib" title="Permalink to this headline">¶</a></h2>
<p>Enthought的官方绘图库是采用Chaco，不过如果你对matplotlib库更加熟悉的话，将matplotlib的绘图控件嵌入TraitsUI界面中将是非常有用的。下面先来看一下嵌入matplotlib控件的完整源代码：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># file name: mpl_figure_editor.py</span>
<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="c"># matplotlib采用WXAgg为后台，这样才能将绘图控件嵌入以wx为后台界面库的traitsUI窗口中</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&quot;WXAgg&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_wxagg</span> <span class="kn">import</span> <span class="n">FigureCanvasWxAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_wx</span> <span class="kn">import</span> <span class="n">NavigationToolbar2Wx</span>
<span class="kn">from</span> <span class="nn">enthought.traits.ui.wx.editor</span> <span class="kn">import</span> <span class="n">Editor</span>
<span class="kn">from</span> <span class="nn">enthought.traits.ui.basic_editor_factory</span> <span class="kn">import</span> <span class="n">BasicEditorFactory</span>

<span class="k">class</span> <span class="nc">_MPLFigureEditor</span><span class="p">(</span><span class="n">Editor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    相当于wx后台界面库中的编辑器，它负责创建真正的控件</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scrollable</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_canvas</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_tooltip</span><span class="p">()</span>
        <span class="k">print</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_create_canvas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        创建一个Panel, 布局采用垂直排列的BoxSizer, panel中中添加</span>
<span class="sd">        FigureCanvas, NavigationToolbar2Wx, StaticText三个控件</span>
<span class="sd">        FigureCanvas的鼠标移动事件调用mousemoved函数，在StaticText</span>
<span class="sd">        显示鼠标所在的数据坐标</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">panel</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CLIP_CHILDREN</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">mousemoved</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">panel</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>        
        <span class="n">panel</span><span class="o">.</span><span class="n">mousemoved</span> <span class="o">=</span> <span class="n">mousemoved</span>
        <span class="n">sizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">panel</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">sizer</span><span class="p">)</span>
        <span class="n">mpl_control</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">panel</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">mpl_control</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&quot;motion_notify_event&quot;</span><span class="p">,</span> <span class="n">mousemoved</span><span class="p">)</span>
        <span class="n">toolbar</span> <span class="o">=</span> <span class="n">NavigationToolbar2Wx</span><span class="p">(</span><span class="n">mpl_control</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">mpl_control</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">LEFT</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">TOP</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">GROW</span><span class="p">)</span>          
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">toolbar</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
        <span class="n">panel</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">panel</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetMinSize</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">panel</span>

<span class="k">class</span> <span class="nc">MPLFigureEditor</span><span class="p">(</span><span class="n">BasicEditorFactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    相当于traits.ui中的EditorFactory，它返回真正创建控件的类</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">klass</span> <span class="o">=</span> <span class="n">_MPLFigureEditor</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>    
    <span class="kn">from</span> <span class="nn">enthought.traits.api</span> <span class="kn">import</span> <span class="n">HasTraits</span><span class="p">,</span> <span class="n">Instance</span>
    <span class="kn">from</span> <span class="nn">enthought.traits.ui.api</span> <span class="kn">import</span> <span class="n">View</span><span class="p">,</span> <span class="n">Item</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">linspace</span><span class="p">,</span> <span class="n">pi</span>

    <span class="k">class</span> <span class="nc">Test</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
        <span class="n">figure</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">Figure</span><span class="p">,</span> <span class="p">())</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span>
            <span class="n">Item</span><span class="p">(</span><span class="s">&quot;figure&quot;</span><span class="p">,</span> <span class="n">editor</span><span class="o">=</span><span class="n">MPLFigureEditor</span><span class="p">(),</span> <span class="n">show_label</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span>
            <span class="n">height</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
            <span class="n">resizable</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Test</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

    <span class="n">Test</span><span class="p">()</span><span class="o">.</span><span class="n">configure_traits</span><span class="p">()</span>    
</pre></div>
</div>
<p>此程序的运行结果如下：</p>
<div class="figure" id="fig-traitsuimanual02">
<img alt="_images/traitsui_manual_02.png" src="_images/traitsui_manual_02.png" />
<p class="caption">在TraitsUI界面中嵌入的matplotlib绘图控件</p>
</div>
<p>由于我们的编辑器没有simple等四种样式，也不会放到wx后台界面库的模块中，因此不能采用上节所介绍的自动查找编辑器类的办法。traits.ui为我们提供一个一个方便的类来完成这些操作：BasicEditorFactory。它的源程序可以在 %ui%basic_editor_factory.py中找到。下面是其中的一部分：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">BasicEditorFactory</span> <span class="p">(</span> <span class="n">EditorFactory</span> <span class="p">):</span>
    <span class="n">klass</span> <span class="o">=</span> <span class="n">Any</span>

    <span class="k">def</span> <span class="nf">_get_simple_editor_class</span> <span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>它通过重载EditorFactory中的simple_editor_class属性，直接返回创建控件的库klass。MPLFigureEditor继承于BasicEditorFactory，指定创建控件的类为_MPLFigureEditor。</p>
<p>和text_editor.SimpleEditor一样，从Editor类继承，在_MPLFigureEditor类的init方法中，创建实际的控件。因为Editor类中有一个update_editor方法，在其对应的trait属性改变是会被调用，而我们的绘图控件不需要这个功能，所以重载update_editor，让它不做任何事情。</p>
<p>matplotlib中，在创建FigureCanvas时需要指定与其对应的Figure对象：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">mpl_control</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">panel</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>这里self.value就是这个Figure对象，它在MVC的模型类Test中被定义为：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">figure</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">Figure</span><span class="p">,</span> <span class="p">())</span>
</pre></div>
</div>
<p>控件类可以通过self.value获得与其对应的模型类中的对象。因此_MPLFigureEditor中的self.value和Test类中的self.figure是同一个对象。</p>
<p>_create_canvas方法中的程序编写和在一个标准的wx窗口中添加控件是一样的，界面库相关的细节不是本书的重点，因此不再详细解释了。读者可以参照matplotlib和wxPython的相应文档。</p>
</div>
<div class="section" id="csv">
<h2>CSV数据绘图工具<a class="headerlink" href="#csv" title="Permalink to this headline">¶</a></h2>
<p>下面用前面介绍的matplotlib编辑器制作一个CSV数据绘图工具。用此工具打开一个CSV数据文档之后，可以绘制多个X-Y坐标图。用户可以自由地添加新的坐标图，修改坐标图的标题，选择坐标图的X轴和Y轴的数据。</p>
<p>下面是此程序的界面截图：</p>
<div class="figure" id="fig-traitsuimanual03">
<img alt="_images/traitsui_manual_03.png" src="_images/traitsui_manual_03.png" />
<p class="caption">CSV数据绘图工具的界面</p>
</div>
<p>图中以标签页的形式显示多个绘图，用户可以从左侧的数据选择栏中选择X轴和Y轴的数据。标签页可以自由的拖动，构成上下左右分栏，并且可以隐藏左侧的数据选择栏：</p>
<div class="figure" id="fig-traitsuimanual04">
<img alt="_images/traitsui_manual_04.png" src="_images/traitsui_manual_04.png" />
<p class="caption">使用可调整DOCK的多标签页界面方便用户对比数据</p>
</div>
<p>由于绘图控件是matplotlib所提供的，因此平移、缩放、保存文件等功能也一应俱全。由于所有的界面都是采用TraitsUI设计的，因此主窗口既可以用来单独显示，也可以嵌入到一个更大的界面中，运用十分灵活。</p>
<p>下面是完整的源程序，运行时需要和mpl_figure_editor.py放在一个文件夹下。包括注释程序一共约170行，编写时间少于一小时。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">mpl_figure_editor</span> <span class="kn">import</span> <span class="n">MPLFigureEditor</span>
<span class="kn">from</span> <span class="nn">enthought.traits.ui.api</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">enthought.traits.api</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="k">class</span> <span class="nc">DataSource</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    数据源，data是一个字典，将字符串映射到列表</span>
<span class="sd">    names是data中的所有字符串的列表</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DictStrAny</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        从CSV文件读入数据，更新data和names属性</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">fieldnames</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">reader</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>        

<span class="k">class</span> <span class="nc">Graph</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    绘图组件，包括左边的数据选择控件和右边的绘图控件</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Str</span> <span class="c"># 绘图名，显示在标签页标题和绘图标题中</span>
    <span class="n">data_source</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">DataSource</span><span class="p">)</span> <span class="c"># 保存数据的数据源</span>
    <span class="n">figure</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">Figure</span><span class="p">)</span> <span class="c"># 控制绘图控件的Figure对象</span>
    <span class="n">selected_xaxis</span> <span class="o">=</span> <span class="n">Str</span> <span class="c"># X轴所用的数据名</span>
    <span class="n">selected_items</span> <span class="o">=</span> <span class="n">List</span> <span class="c"># Y轴所用的数据列表</span>

    <span class="n">clear_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="s">u&quot;清除&quot;</span><span class="p">)</span> <span class="c"># 快速清除Y轴的所有选择的数据</span>

    <span class="n">view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span>
        <span class="n">HSplit</span><span class="p">(</span> <span class="c"># HSplit分为左右两个区域，中间有可调节宽度比例的调节手柄</span>
            <span class="c"># 左边为一个组</span>
            <span class="n">VGroup</span><span class="p">(</span>
                <span class="n">Item</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">),</span>   <span class="c"># 绘图名编辑框</span>
                <span class="n">Item</span><span class="p">(</span><span class="s">&quot;clear_button&quot;</span><span class="p">),</span> <span class="c"># 清除按钮</span>
                <span class="n">Heading</span><span class="p">(</span><span class="s">u&quot;X轴数据&quot;</span><span class="p">),</span>  <span class="c"># 静态文本</span>
                <span class="c"># X轴选择器，用EnumEditor编辑器，即ComboBox控件，控件中的候选数据从</span>
                <span class="c"># data_source的names属性得到</span>
                <span class="n">Item</span><span class="p">(</span><span class="s">&quot;selected_xaxis&quot;</span><span class="p">,</span> <span class="n">editor</span><span class="o">=</span>
                    <span class="n">EnumEditor</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;object.data_source.names&quot;</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)),</span>
                <span class="n">Heading</span><span class="p">(</span><span class="s">u&quot;Y轴数据&quot;</span><span class="p">),</span> <span class="c"># 静态文本</span>
                <span class="c"># Y轴选择器，由于Y轴可以多选，因此用CheckBox列表编辑，按两列显示</span>
                <span class="n">Item</span><span class="p">(</span><span class="s">&quot;selected_items&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;custom&quot;</span><span class="p">,</span> 
                     <span class="n">editor</span><span class="o">=</span><span class="n">CheckListEditor</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;object.data_source.names&quot;</span><span class="p">,</span> 
                            <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">format_str</span><span class="o">=</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)),</span>
                <span class="n">show_border</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="c"># 显示组的边框</span>
                <span class="n">scrollable</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>  <span class="c"># 组中的控件过多时，采用滚动条</span>
                <span class="n">show_labels</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># 组中的所有控件都不显示标签</span>
            <span class="p">),</span>
            <span class="c"># 右边绘图控件</span>
            <span class="n">Item</span><span class="p">(</span><span class="s">&quot;figure&quot;</span><span class="p">,</span> <span class="n">editor</span><span class="o">=</span><span class="n">MPLFigureEditor</span><span class="p">(),</span> <span class="n">show_label</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
        <span class="p">)</span>        
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_name_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        当绘图名发生变化时，更新绘图的标题</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_clear_button_fired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        清除按钮的事件处理</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_figure_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        figure属性的缺省值，直接创建一个Figure对象</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">figure</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">()</span>
        <span class="n">figure</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">])</span> <span class="c">#添加绘图区域，四周留有边距</span>
        <span class="k">return</span> <span class="n">figure</span>

    <span class="k">def</span> <span class="nf">_selected_items_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Y轴数据选择更新</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_selected_xaxis_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        X轴数据选择更新</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        重新绘制所有的曲线</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="n">axe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_xaxis</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> 
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_items</span><span class="p">:</span>
            <span class="n">axe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">field</span><span class="p">)</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_xaxis</span><span class="p">)</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">axe</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">CSVGrapher</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    主界面包括绘图列表，数据源，文件选择器和添加绘图按钮</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">graph_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Instance</span><span class="p">(</span><span class="n">Graph</span><span class="p">))</span> <span class="c"># 绘图列表</span>
    <span class="n">data_source</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">DataSource</span><span class="p">)</span> <span class="c"># 数据源</span>
    <span class="n">csv_file_name</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="p">[</span><span class="s">u&quot;*.csv&quot;</span><span class="p">])</span> <span class="c"># 文件选择</span>
    <span class="n">add_graph_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="s">u&quot;添加绘图&quot;</span><span class="p">)</span> <span class="c"># 添加绘图按钮</span>

    <span class="n">view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span>
        <span class="c"># 整个窗口分为上下两个部分</span>
        <span class="n">VGroup</span><span class="p">(</span>
            <span class="c"># 上部分横向放置控件，因此用HGroup</span>
            <span class="n">HGroup</span><span class="p">(</span>
                <span class="c"># 文件选择控件</span>
                <span class="n">Item</span><span class="p">(</span><span class="s">&quot;csv_file_name&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">u&quot;选择CSV文件&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">),</span>
                <span class="c"># 添加绘图按钮</span>
                <span class="n">Item</span><span class="p">(</span><span class="s">&quot;add_graph_button&quot;</span><span class="p">,</span> <span class="n">show_label</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="c"># 下部分是绘图列表，采用ListEditor编辑器显示</span>
            <span class="n">Item</span><span class="p">(</span><span class="s">&quot;graph_list&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&quot;custom&quot;</span><span class="p">,</span> <span class="n">show_label</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
                 <span class="n">editor</span><span class="o">=</span><span class="n">ListEditor</span><span class="p">(</span>
                     <span class="n">use_notebook</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="c"># 是用多标签页格式显示</span>
                     <span class="n">deletable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="c"># 可以删除标签页</span>
                     <span class="n">dock_style</span><span class="o">=</span><span class="s">&quot;tab&quot;</span><span class="p">,</span> <span class="c"># 标签dock样式</span>
                     <span class="n">page_name</span><span class="o">=</span><span class="s">&quot;.name&quot;</span><span class="p">)</span> <span class="c"># 标题页的文本使用Graph对象的name属性</span>
                <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">resizable</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">u&quot;CSV数据绘图器&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_csv_file_name_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        打开新文件时的处理，根据文件创建一个DataSource</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">load_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_file_name</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="p">[:]</span>

    <span class="k">def</span> <span class="nf">_add_graph_button_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        添加绘图按钮的事件处理</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Graph</span><span class="p">(</span><span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span> <span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">csv_grapher</span> <span class="o">=</span> <span class="n">CSVGrapher</span><span class="p">()</span>
    <span class="n">csv_grapher</span><span class="o">.</span><span class="n">configure_traits</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>程序中已经有比较详细的注释，这里就不再重复。如果你对traits库的某项用法还不太了解的话，可以直接查看其源代码，代码中都有详细的注释。下面是几个比较重点的部分：</p>
<ul>
<li><p class="first">整个程序的界面处理都只是组装View对象，看不到任何关于控件操作的代码，因此大大地节省了程序的开发时间。</p>
</li>
<li><p class="first">通过配置141行的ListEditor，使其用标签页的方式显示graph_list中的每个元素，以此管理多个Graph对象。</p>
</li>
<li><p class="first">在43行中，Graph类用HSplit将其数据选择部分和绘图控件部分分开，HSplit提供的更改左右部分的比例和隐藏的功能。</p>
</li>
<li><p class="first">本书写作时所采用的traitsUI库版本为3.2，如果在标签页标题中输入中文，会出现错误，这是因为TraitsUI中还有些代码对unicode的支持不够，希望日后会有所改善。目前可以通过分析错误提示信息，修改TraitsUI库的源代码，只需要将下面提示中的770行中的str改为unicode既可以修复。</p>
<blockquote>
<div class="highlight-python"><pre>File "C:\Python26\lib\site-packages\traitsbackendwx-3.2.0-py2.6.egg\enthought\
traits\ui\wx\list_editor.py", line 770, in _create_page
name = str( name ) or '???'
UnicodeEncodeError: 'ascii' codec can't encode characters in position 0-1:
ordinal not in range(128)</pre>
</div>
</blockquote>
</li>
<li><p class="first">matplotlib的绘图中是可以使用中文的，但是由于缺省字体不是中文字体，因此中文都变为方块，你可以按照  <a class="reference external" href="pydoc_write_tools.html#chinese-in-matplotlib"><em>让Matplotlib显示中文</em></a> 中所述修改matplotlib的字体。</p>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">首页目录</a></h3>
            <ul>
<li><a class="reference external" href="#">设计自己的Trait编辑器</a><ul>
<li><a class="reference external" href="#id1">Trait编辑器的工作原理</a></li>
<li><a class="reference external" href="#matplotlib">制作matplotlib的编辑器</a></li>
<li><a class="reference external" href="#csv">CSV数据绘图工具</a></li>
</ul>
</li>
</ul>

            <h4>上一篇文章</h4>
            <p class="topless"><a href="traits_manual_notification.html"
                                  title="上一篇文章">Trait事件处理</a></p>
            <h4>下一篇文章</h4>
            <p class="topless"><a href="visual_manual_index.html"
                                  title="下一篇文章">Visual使用手册</a></p>
          <div id="searchbox" style="display: none">
            <h3>快速搜索</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="搜索" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              中文搜索请尽量用空格分开单个的单词，例如搜索"科学 计算"，而不是"科学计算"
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="visual_manual_index.html" title="Visual使用手册"
             >下一篇</a></li>
        <li class="right" >
          <a href="traits_manual_notification.html" title="Trait事件处理"
             >上一篇</a> |</li>
        <li class="right" style="margin-right:10px">
        <a href="#" id="toggle_sidebar">←切换侧栏(Alt+X)</a> |
        </li>
        <li><a href="index.html">用Python做科学计算</a> &raquo;</li>
          <li><a href="traits_manual_index.html" >Traits使用手册</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    &copy; 2009, <a href="http://hyry.dip.jp/blogt.py">HYRY Studio</a>
      由 <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.4. 编译
    </div>
  </body>
</html>